<ion-header class="header" [translucent]="false">
  <ion-toolbar class="header-toolbar">
    <ion-buttons slot="start">
      <ion-button fill="clear" class="back-button" (click)="regresar()">
        <ion-icon name="chevron-back-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title class="header-title">
      <span class="title-text">{{item.itemname}}</span>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" class="favorite-button" *ngIf="item.favorito===false && creador===true" (click)="Favorito()">
        <ion-icon name="heart-outline" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button fill="clear" class="favorite-button active" *ngIf="item.favorito===true && creador===true" (click)="Favorito()">
        <ion-icon name="heart" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button fill="clear" class="menu-button" id="popover-button2">
        <ion-icon name="ellipsis-vertical-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-progress-bar *ngIf="isLoading===true" color="warning" type="indeterminate" class="progress-bar"></ion-progress-bar>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">

  <ion-refresher slot="fixed" [pullFactor]="0.5" [pullMin]="100" [pullMax]="200" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="cards-container">
    <ion-item [class.disabled-overlay]="item.estado" lines="none">
      <ion-reorder-group [disabled]="isDisabled" (ionItemReorder)="handleReorder($any($event))" class="reorder-group">
        <ion-item class="bolsillo-item" [class.card-disabled]="item.estado" #capturableArea [id]="'item-' + x" *ngFor="let bolsillo of item.bolsillos; let x=index;">
          <ion-card class="bolsillo-card">
            <ion-card-header class="bolsillo-header" [style.border-left-color]="bolsillo.color">
              <div class="bolsillo-title-row">
                <ion-card-title class="bolsillo-title">{{bolsillo.nombre}}</ion-card-title>
                <div class="bolsillo-actions">
                  <ion-button 
                    fill="clear" 
                    class="bolsillo-add-btn" 
                    *ngIf="(compartirUno.estado || creador) && !item.estado"
                    (click)="openDepositoModal(bolsillo)"
                    title="Agregar/restar depósito">
                    <ion-icon name="add-circle-outline" [style.color]="bolsillo.color"></ion-icon>
                  </ion-button>
                  <ion-button 
                    fill="clear" 
                    class="bolsillo-menu-btn" 
                    [id]="'popover-' + x" 
                    *ngIf="compartirUno.estado===true || creador===true"
                    [disabled]="item.estado">
                    <ion-icon name="ellipsis-horizontal-outline" [style.color]="bolsillo.color"></ion-icon>
                  </ion-button>
                </div>
                
                <!--Opciones para los bolsillos-->
                <ion-popover [trigger]="'popover-' + x" [dismissOnSelect]="true" alignment="start" size="auto" class="bolsillo-popover">
                  <ng-template>
                    <ion-content>
                      <ion-list class="popover-list">
                        <ion-item [button]="true" [detail]="false" (click)="openModalEditar = !openModalEditar; EditarBolsillo(bolsillo)" class="popover-item">
                          <ion-icon name="create-outline" slot="start"></ion-icon>
                          <ion-label>Editar bolsillo</ion-label>
                        </ion-item>
                        <ion-item [button]="true" [detail]="false" (click)="EliminarDepositos(bolsillo.id!)" class="popover-item">
                          <ion-icon name="trash-outline" slot="start"></ion-icon>
                          <ion-label>Eliminar depósitos</ion-label>
                        </ion-item>
                        <ion-item [button]="true" [detail]="false" (click)="EliminarItem(x)" class="popover-item destructive">
                          <ion-icon name="close-circle-outline" slot="start"></ion-icon>
                          <ion-label>Eliminar bolsillo</ion-label>
                        </ion-item>
                      </ion-list>
                    </ion-content>
                  </ng-template>
                </ion-popover>
              </div>

              <!--Titulos de las cantidades-->
              <div class="bolsillo-values" *ngIf="bolsillo.Vinicial">
                <div class="value-row">
                  <span class="value-label">Inicial</span>
                  <span class="value-amount">${{formatNumberMil(bolsillo.valor!)}}</span>
                </div>
                <div class="value-row">
                  <span class="value-label">Depósitos</span>
                  <span class="value-amount">${{formatNumberMil(bolsillo.subtotal)}}</span>
                </div>
                <div class="value-row total-row">
                  <span class="value-label">Total</span>
                  <span class="value-amount total">${{formatNumberMil(bolsillo.valor!+bolsillo.subtotal)}}</span>
                </div>
              </div>
              <div class="bolsillo-values" *ngIf="!bolsillo.Vinicial">
                <div class="value-row">
                  <span class="value-label positive">Ingresos</span>
                  <span class="value-amount positive">${{Positivo(bolsillo)}}</span>
                </div>
                <div class="value-row">
                  <span class="value-label negative">Egresos</span>
                  <span class="value-amount negative">${{Negativo(bolsillo)}}</span>
                </div>
                <div class="value-row total-row">
                  <span class="value-label">Total</span>
                  <span class="value-amount total">${{formatNumberMil(bolsillo.subtotal)}}</span>
                </div>
              </div>

              <ion-button 
                expand="full" 
                class="toggle-details-btn" 
                [style.--background]="bolsillo.color"
                (click)="show(x)"
                [disabled]="false">
                <ion-icon [name]="cardStates[x] ? 'chevron-up-outline' : 'chevron-down-outline'" slot="start"></ion-icon>
                {{cardStates[x] ? 'Ocultar detalles' : 'Ver detalles'}}
              </ion-button>
            </ion-card-header>

            <ion-card-content *ngIf="cardStates[x]===true" class="bolsillo-content">
              <div class="depositos-section">
                <div class="depositos-header">
                  <span class="depositos-label">Depósitos</span>
                </div>
                <div class="depositos-list" *ngIf="bolsillo.depositos && bolsillo.depositos.length > 0">
                  <div class="deposito-item" *ngFor="let deposito of bolsillo.depositos; let z=index">
                    <div class="deposito-info">
                      <span class="deposito-value">${{formatNumberMil(deposito.valor)}}</span>
                      <span class="deposito-comment" *ngIf="deposito.comentario">{{deposito.comentario}}</span>
                    </div>
                    <ion-button
                      fill="clear"
                      size="small"
                      class="delete-deposito-btn"
                      *ngIf="(compartirUno.estado===true || creador===true) && !item.estado"
                      (click)="presentActionSheetEliminar(bolsillo,deposito)">
                      <ion-icon name="trash-outline"></ion-icon>
                    </ion-button>
                  </div>
                </div>
                <div class="empty-depositos" *ngIf="!bolsillo.depositos || bolsillo.depositos.length === 0">
                  <ion-icon name="receipt-outline"></ion-icon>
                  <p>No hay depósitos registrados</p>
                </div>
              </div>

              <div class="disabled-message" *ngIf="item.estado">
                <ion-icon name="lock-closed-outline"></ion-icon>
                <p>La tarjeta está desactivada. Actívala desde el menú para realizar cambios.</p>
              </div>
              <ion-button 
                expand="block" 
                class="capture-btn" 
                [style.--background]="bolsillo.color" 
                (click)="CapturaPantalla(x)"
                [disabled]="item.estado">
                <ion-icon name="camera-outline" slot="start"></ion-icon>
                Capturar pantalla
              </ion-button>
            </ion-card-content>
          </ion-card>
          <ion-reorder slot="end" class="reorder-handle"></ion-reorder>
        </ion-item>
      </ion-reorder-group>
    </ion-item>
    
    <ion-button 
      *ngIf="!isDisabled" 
      expand="block" 
      fill="outline" 
      class="close-reorder-btn" 
      (click)="toggleReorder()">
      <ion-icon name="checkmark-outline" slot="start"></ion-icon>
      Finalizar orden
    </ion-button>
  </div>
  
  <!-- Resumen total fijo -->
  <div class="totals-card-fixed">
    <div class="totals-content-fixed">
      <div class="total-row-item-fixed">
        <div class="total-item">
          <span class="total-label-fixed positive">Ingresos</span>
          <span class="total-amount-fixed positive">${{formatNumberMil(positivos)}}</span>
        </div>
        <div class="total-item">
          <span class="total-label-fixed negative">Gastos</span>
          <span class="total-amount-fixed negative">${{formatNumberMil(negativos)}}</span>
        </div>
        <div class="total-item final">
          <span class="total-label-fixed">Total</span>
          <span class="total-amount-fixed final">${{formatNumberMil(Totalresultado)}}</span>
        </div>
      </div>
    </div>
  </div>

<!--Modal Crear bolsillo-->
  <ion-modal #modal [isOpen]="openModal" (willDismiss)="onWillDismiss($event)" class="bolsillo-modal">
    <ng-template>
      <ion-header class="modal-header">
        <ion-toolbar class="modal-toolbar">
          <ion-buttons slot="start">
            <ion-button fill="clear" class="modal-close-btn" (click)="cancel()">
              <ion-icon name="close-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-buttons>
          <ion-title class="modal-title">Nuevo bolsillo</ion-title>
          <ion-buttons slot="end">
            <ion-button fill="clear" class="modal-confirm-btn" (click)="confirm()" [strong]="true">
              Guardar
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="modal-content">
        <div class="modal-form">
          <div class="form-field">
            <ion-item lines="none" class="form-item">
              <ion-label position="stacked" class="form-label">
                <ion-icon name="pricetag-outline"></ion-icon>
                Nombre del bolsillo
              </ion-label>
              <ion-input
                type="text"
                placeholder="Ej: Ahorros, Gastos..."
                [(ngModel)]="bolsillo.nombre"
                [counter]="true"
                maxlength="12"
                class="form-input">
              </ion-input>
            </ion-item>
          </div>

          <div class="form-field" *ngIf="!item.estadohistorial">
            <ion-item lines="none" class="form-item">
              <ion-label>
                <div class="toggle-label">
                  <ion-icon name="wallet-outline"></ion-icon>
                  <span>Valor inicial</span>
                </div>
                <p class="toggle-description">Incluir un valor inicial para este bolsillo</p>
              </ion-label>
              <ion-toggle 
                [(ngModel)]="bolsillo.Vinicial"
                [enableOnOffLabels]="true" 
                color="primary">
              </ion-toggle>
            </ion-item>
          </div>

          <div class="form-field" *ngIf="item.estadohistorial || bolsillo.Vinicial === true">
            <ion-item lines="none" class="form-item">
              <ion-label position="stacked" class="form-label">
                <ion-icon name="cash-outline"></ion-icon>
                Valor inicial
              </ion-label>
              <ion-input
                type="number"
                placeholder="Ingresa el valor"
                [(ngModel)]="bolsillo.valor"
                class="form-input">
              </ion-input>
            </ion-item>
          </div>

          <div class="form-field">
            <ion-item lines="none" class="form-item color-picker-item">
              <ion-label position="stacked" class="form-label">
                <ion-icon name="color-palette-outline"></ion-icon>
                Color del bolsillo
              </ion-label>
              <div class="color-picker-wrapper">
                <input 
                  type="color" 
                  class="color-picker-input" 
                  [(ngModel)]="bolsillo.color"/>
                <div class="color-preview" [style.background]="bolsillo.color"></div>
              </div>
            </ion-item>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

<!--Modal editar bolsillo-->
  <ion-modal #modalEditar [isOpen]="openModalEditar" (willDismiss)="onWillDismissE($event)" class="bolsillo-modal">
    <ng-template>
      <ion-header class="modal-header">
        <ion-toolbar class="modal-toolbar">
          <ion-buttons slot="start">
            <ion-button fill="clear" class="modal-close-btn" (click)="cancel2()">
              <ion-icon name="close-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-buttons>
          <ion-title class="modal-title">Editar bolsillo</ion-title>
          <ion-buttons slot="end">
            <ion-button fill="clear" class="modal-confirm-btn" (click)="confirmEditar()" [strong]="true">
              Guardar
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="modal-content">
        <div class="modal-form">
          <div class="form-field">
            <ion-item lines="none" class="form-item">
              <ion-label position="stacked" class="form-label">
                <ion-icon name="pricetag-outline"></ion-icon>
                Nombre del bolsillo
              </ion-label>
              <ion-input
                type="text"
                placeholder="Ej: Ahorros, Gastos..."
                [(ngModel)]="bolsilloEditar.nombre"
                [counter]="true"
                maxlength="12"
                class="form-input">
              </ion-input>
            </ion-item>
          </div>

          <div class="form-field" *ngIf="!item.estadohistorial">
            <ion-item lines="none" class="form-item">
              <ion-label>
                <div class="toggle-label">
                  <ion-icon name="wallet-outline"></ion-icon>
                  <span>Valor inicial</span>
                </div>
                <p class="toggle-description">Incluir un valor inicial para este bolsillo</p>
              </ion-label>
              <ion-toggle 
                [(ngModel)]="bolsilloEditar.Vinicial"
                [enableOnOffLabels]="true" 
                color="primary">
              </ion-toggle>
            </ion-item>
          </div>

          <div class="form-field" *ngIf="item.estadohistorial || bolsilloEditar.Vinicial === true">
            <ion-item lines="none" class="form-item">
              <ion-label position="stacked" class="form-label">
                <ion-icon name="cash-outline"></ion-icon>
                Valor inicial
              </ion-label>
              <ion-input
                type="number"
                placeholder="Ingresa el valor"
                [(ngModel)]="bolsilloEditar.valor"
                class="form-input">
              </ion-input>
            </ion-item>
          </div>

          <div class="form-field">
            <ion-item lines="none" class="form-item color-picker-item">
              <ion-label position="stacked" class="form-label">
                <ion-icon name="color-palette-outline"></ion-icon>
                Color del bolsillo
              </ion-label>
              <div class="color-picker-wrapper">
                <input 
                  type="color" 
                  class="color-picker-input" 
                  [(ngModel)]="bolsilloEditar.color"/>
                <div class="color-preview" [style.background]="bolsilloEditar.color"></div>
              </div>
            </ion-item>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>


<!--Popover de las opciones en el menú-->
  <ion-popover trigger="popover-button2" [dismissOnSelect]="true" class="custom-popover">
    <ng-template>
      <ion-content class="popover-content">
        <ion-list *ngIf="compartirUno.estado===true || creador===true" class="popover-list">
          <ion-item [button]="true" [detail]="false" (click)="openModal = !openModal" class="popover-item">
            <ion-icon name="add-circle-outline" slot="start"></ion-icon>
            <ion-label>Nuevo bolsillo</ion-label>
          </ion-item>
          <ion-item *ngIf="creador===true" [button]="true" [detail]="false" (click)="EditarNombreTarjeta()" class="popover-item">
            <ion-icon name="create-outline" slot="start"></ion-icon>
            <ion-label>Editar tarjeta</ion-label>
          </ion-item>
          <ion-item [button]="true" [detail]="false" (click)="Compartir()" class="popover-item">
            <ion-icon name="people-outline" slot="start"></ion-icon>
            <ion-label>Compartir</ion-label>
          </ion-item>
          <ion-item [button]="true" [detail]="false" (click)="toggleReorder()" class="popover-item">
            <ion-icon name="swap-vertical-outline" slot="start"></ion-icon>
            <ion-label>Ordenar bolsillos</ion-label>
          </ion-item>
          <ion-item [button]="true" id="nested-trigger" class="popover-item">
            <ion-icon name="funnel-outline" slot="start"></ion-icon>
            <ion-label>Ordenar por</ion-label>
            <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
          </ion-item>
          <ion-item *ngIf="item.estadohistorial" [button]="true" [detail]="false" (click)="RutaHistorial()" class="popover-item">
            <ion-icon name="time-outline" slot="start"></ion-icon>
            <ion-label>Ver historial</ion-label>
          </ion-item>
          <ion-item *ngIf="compartirUno.estado===true || creador===true" [button]="true" [detail]="false" (click)="Festado(item.estado ? 'activar' : 'desactivar')" class="popover-item">
            <ion-icon [name]="item.estado ? 'eye-outline' : 'eye-off-outline'" slot="start"></ion-icon>
            <ion-label>{{item.estado ? 'Activar tarjeta' : 'Desactivar tarjeta'}}</ion-label>
          </ion-item>
          <ion-item [button]="true" [detail]="false" (click)="EliminarTarjeta()" class="popover-item destructive">
            <ion-icon name="trash-outline" slot="start"></ion-icon>
            <ion-label>Eliminar tarjeta</ion-label>
          </ion-item>

          <ion-popover trigger="nested-trigger" [dismissOnSelect]="true" side="end" class="nested-popover">
            <ng-template>
              <ion-content>
                <ion-list class="popover-list">
                  <ion-item class="popover-header">
                    <ion-label><strong>Ordenar por</strong></ion-label>
                  </ion-item>
                  <ion-item [button]="true" [detail]="false" (click)="Ordenar('nombre')" class="popover-item">
                    <ion-icon name="text-outline" slot="start"></ion-icon>
                    <ion-label>Nombre</ion-label>
                  </ion-item>
                  <ion-item [button]="true" [detail]="false" (click)="Ordenar('favorito')" class="popover-item">
                    <ion-icon name="star-outline" slot="start"></ion-icon>
                    <ion-label>Favorito</ion-label>
                  </ion-item>
                </ion-list>
              </ion-content>
            </ng-template>
          </ion-popover>
        </ion-list>

        <ion-list *ngIf="compartirUno.estado===false" class="popover-list">
          <ion-item [button]="true" [detail]="false" (click)="setOpen(true)" class="popover-item">
            <ion-icon name="people-outline" slot="start"></ion-icon>
            <ion-label>Ver integrantes</ion-label>
          </ion-item>
          <ion-item [button]="true" [detail]="false" (click)="EliminarCompartida(user.id!)" class="popover-item destructive">
            <ion-icon name="log-out-outline" slot="start"></ion-icon>
            <ion-label>Eliminar compartida</ion-label>
          </ion-item>
        </ion-list>
      </ion-content>
    </ng-template>
  </ion-popover>

  <!--Modal Agregar/Restar Depósito-->
  <ion-modal #modalDeposito [isOpen]="openModalDeposito" (willDismiss)="onWillDismissDeposito($event)" class="deposito-modal">
    <ng-template>
      <ion-header class="modal-header">
        <ion-toolbar class="modal-toolbar">
          <ion-buttons slot="start">
            <ion-button fill="clear" class="modal-close-btn" (click)="cancelDeposito()">
              <ion-icon name="close-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-buttons>
          <ion-title class="modal-title">Agregar depósito</ion-title>
          <ion-buttons slot="end"></ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="modal-content">
        <div class="modal-form">
          <div class="form-field">
            <ion-item lines="none" class="form-item">
              <ion-label position="stacked" class="form-label">
                <ion-icon name="cash-outline"></ion-icon>
                Valor
              </ion-label>
              <ion-input 
                type="number" 
                [(ngModel)]="deposito.valor" 
                placeholder="Ingresa el valor" 
                class="form-input"
                autofocus>
              </ion-input>
            </ion-item>
          </div>

          <div class="form-field">
            <ion-item lines="none" class="form-item">
              <ion-label position="stacked" class="form-label">
                <ion-icon name="chatbubble-outline"></ion-icon>
                Comentario (opcional)
              </ion-label>
              <ion-textarea 
                [(ngModel)]="deposito.comentario" 
                placeholder="Agrega un comentario..."
                [counter]="true" 
                maxlength="60"
                rows="2"
                class="form-textarea">
              </ion-textarea>
            </ion-item>
          </div>

          <div class="action-buttons-modal">
            <ion-button 
              expand="block" 
              *ngIf="!item.estadohistorial && selectedBolsillo" 
              (click)="depositar(selectedBolsillo!, 'sumar')" 
              class="add-btn-modal"
              [style.--background]="selectedBolsillo.color || '#027abb'"
              [disabled]="!deposito.valor || (deposito.valor ?? 0) <= 0">
              <ion-icon name="add-outline" slot="start"></ion-icon>
              Agregar
            </ion-button>
            <ion-button 
              expand="block" 
              *ngIf="selectedBolsillo"
              (click)="depositar(selectedBolsillo!, 'restar')" 
              class="subtract-btn-modal"
              color="warning"
              [disabled]="!deposito.valor || (deposito.valor ?? 0) <= 0">
              <ion-icon name="remove-outline" slot="start"></ion-icon>
              Restar
            </ion-button>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>
